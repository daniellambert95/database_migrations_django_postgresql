# database_migrations_django_postgresql

This README is here to assist me when having to make Data Migrations
from a Django Postgres DB it is also a step-by-step guide.

- Create a venv
- Create a new Django Project
- Create and register a model in an app

### Creating postgresql database

$ createdb -h localhost \
-- createdb -h <db_name> \
$ psql -h localhost  \
-- psql -h <db_name>

=# DROP DATABASE IF EXISTS addressbook_django; \
=# CREATE DATABASE addressbook_django; \

=# CREATE USER username WITH PASSWORD 'password'; \
=#  ALTER ROLE username SET client_encoding TO ‘utf8’; \
=#  ALTER ROLE username SET default_transaction_isolation TO ‘read committed’; \
=#  ALTER DATABASE postgres SET timezone TO 'UTC'; \
=#  GRANT ALL PRIVILEGES ON DATABASE addressbook_django TO username; \
=#  \q \

- $ pip install django psycopg2

### Change DATABASES in settings.py and import local_settings.py / environment variables

DATABASES = { \
    'default': { \
        'ENGINE': 'django.db.backends.postgresql_psycopg2', \
        'NAME': 'addressbook_django', \
        'USER': 'daniel', \
        'PASSWORD': PASSWORD, \
        'HOST': 'localhost', \
        'POST': '', \
    } \
} \

- Edit ALLOWED HOSTS
just add '*'

- At the bottom of settings (Imports the password)
try:
    from local_settings import *
except ImportError:
    pass

### Create a model

class Address(models.Model): \
    name = models.CharField(max_length=80, blank=False) \
    email = models.EmailField(blank=False) \
    address = models.CharField(max_length=200,  blank=False) \

    class Meta:
        verbose_name = "address book"
        verbose_name_plural = "Address's"
        db_table = 'address_book'

    def __str__(self):
        return f"Here is the address for {self.name}"

### Register your model in admin.py

from django.contrib import admin
from .models import Address

1. admin.site.register(Address)

or

2. @admin.register(Address) \
class addressAdmin(admin.ModelAdmin): \
    list_display = ('id', 'name', 'email', 'address') \

# Make migrations and migrate

$ python manage.py makemigrations
$ python manage.py migrate

# Create superuser, runserver and add data to the model

$ python manage.py createsuperuser
$ python manage.py runderver
- http://127.0.0.1:8000/admin


### Data Migration

- Add a attribute / field to the models class

postcode = models.CharField(max_length=25, default="00000") \

$ python manage.py makemigrations \
$ python manage.py migrate \

- update admin.py - list_display+= 'postcode \

- Now to create an empty migrations 
python manage.py makemigrations --empty addressbook (<---) appname
- Rename the 0004_auto_migrations to e.g. 0004_address_to_postcode.py

### Create a backup database before proceeding
- $ pg_dump -U database_user_name -W -h 127.0.0.1 addressbook_django > database_backup.sql 
- $ pg_dump -U database_user_name -W -h <domain> <database_name> > file_name.sql 

### Writing logic for migrations file 
- Template: https://docs.djangoproject.com/en/4.0/topics/migrations/#:~:text=from%20django.db%20import%20migrations%0A%0Adef,yourappname%27%2C%20%270001_initial%27)%2C%0A%20%20%20%20%5D%0A%0A%20%20%20%20operations%20%3D%20%5B%0A%20%20%20%20%20%20%20%20migrations.RunPython(combine_names)%2C%0A%20%20%20%20%5D

- Migration_file - 0004_xyzxyz
Generated by Django 4.0.2 on 2022-02-02 12:54

from django.db import migrations
import re

def extract_postcode(apps, schema_editor): \
    # We can't import the Address model directly as it may be a newer \
    # version than this migration expects. We use the historical version. \
    Address = apps.get_model('addressbook', 'Address') \
    for address in Address.objects.all(): \
        postcodes = re.findall(r"(?<!\d)\d{5}(?!\d)", address.address) \
        if len(postcodes) > 0: \
            address.postcode = postcodes[0] \
        address.save() \

class Migration(migrations.Migration):

    dependencies = [
        ('addressbook', '0003_address_postcode'),
    ]

    operations = [
        migrations.RunPython(extract_postcode),
    ]

- Execute migrations & runserver
$ python manage.py makemigrations \
$ python manage.py migrate \
$ python manage.py runserver \

- You can remove the address attribute from Address model so you are left with just the postcode
